{% extends "base.html" %}
{% block page_title %}Dashboard{% endblock %}
{% block content %}

<div class="muted" style="margin-bottom:10px;">
  Data snapshot as of {{ kpis.today }}
</div>

<div class="grid">
  <div class="card">
    <div class="card__label">Revenue (net) — last 7 days</div>
    <div class="card__value">€{{ "%.2f"|format(kpis.rev_7d) }}</div>
    <div class="muted">Units: {{ kpis.units_7d }}</div>
  </div>
  <div class="card">
    <div class="card__label">Profit — last 7 days</div>
    <div class="card__value">€{{ "%.2f"|format(kpis.profit_7d) }}</div>
    <div class="muted">Margin: {{ "%.2f"|format(kpis.margin_7d) }}%</div>
  </div>

  <div class="card">
    <div class="card__label">Revenue (net) — month to date</div>
    <div class="card__value">€{{ "%.2f"|format(kpis.rev_mtd) }}</div>
    <div class="muted">Units: {{ kpis.units_mtd }}</div>
  </div>
  <div class="card">
    <div class="card__label">Profit — month to date</div>
    <div class="card__value">€{{ "%.2f"|format(kpis.profit_mtd) }}</div>
    <div class="muted">Margin: {{ "%.2f"|format(kpis.margin_mtd) }}%</div>
  </div>

  <div class="card">
    <div class="card__label">Missing cost basis lines (MTD)</div>
    <div class="card__value">{{ kpis.missing_cost_lines_mtd }}</div>
    <div class="muted">Usually means no Purchases landed cost yet for that SKU.</div>
  </div>

  <div class="card">
    <div class="card__label">Quick actions</div>
    <div class="card__value" style="font-size: 14px; line-height: 1.6;">
      <a href="{{ url_for('sales.list_sales_orders') }}">Sales</a><br>
      <a href="{{ url_for('sales.import_upload') }}">Import sales CSV</a><br>
      <a href="{{ url_for('purchases.list_purchase_orders') }}">Purchases</a><br>
      <a href="{{ url_for('catalog.list_items') }}">Catalog</a>
    </div>
  </div>
</div>

<div class="grid mt-16">
  <div class="card">
    <div class="card__header">
      <div>
        <div class="h2">Top SKUs (units) — MTD</div>
        <div class="muted">Top 10 by quantity sold</div>
      </div>
    </div>
    <div class="card__body">
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Description</th>
              <th class="td-right">Units</th>
              <th class="td-right">Revenue (net)</th>
              <th class="td-right">Profit</th>
              <th class="td-right">Margin %</th>
            </tr>
          </thead>
          <tbody>
            {% for r in top_by_units %}
              {% set rev = r.rev or 0 %}
              {% set prof = r.profit or 0 %}
              {% set margin = 0 %}
              {% if rev and rev > 0 %}
                {% set margin = (prof / rev) * 100 %}
              {% endif %}
              <tr>
                <td><strong>{{ r.sku }}</strong></td>
                <td class="muted">{{ r.description or "" }}</td>
                <td class="td-right">{{ r.units or 0 }}</td>
                <td class="td-right">{{ "%.2f"|format(rev) }}</td>
                <td class="td-right">{{ "%.2f"|format(prof) }}</td>
                <td class="td-right">{{ "%.2f"|format(margin) }}</td>
              </tr>
            {% endfor %}
            {% if top_by_units|length == 0 %}
              <tr><td colspan="6" class="muted">No sales yet for this month.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
      <div class="mt-16">
        <a class="btn btn--ghost btn--sm" href="{{ url_for('sales.items_report') }}">Open full items report</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <div>
        <div class="h2">Top SKUs (profit) — MTD</div>
        <div class="muted">Top 10 by gross profit</div>
      </div>
    </div>
    <div class="card__body">
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>SKU</th>
              <th>Description</th>
              <th class="td-right">Units</th>
              <th class="td-right">Revenue (net)</th>
              <th class="td-right">Profit</th>
              <th class="td-right">Margin %</th>
            </tr>
          </thead>
          <tbody>
            {% for r in top_by_profit %}
              {% set rev = r.rev or 0 %}
              {% set prof = r.profit or 0 %}
              {% set margin = 0 %}
              {% if rev and rev > 0 %}
                {% set margin = (prof / rev) * 100 %}
              {% endif %}
              <tr>
                <td><strong>{{ r.sku }}</strong></td>
                <td class="muted">{{ r.description or "" }}</td>
                <td class="td-right">{{ r.units or 0 }}</td>
                <td class="td-right">{{ "%.2f"|format(rev) }}</td>
                <td class="td-right">{{ "%.2f"|format(prof) }}</td>
                <td class="td-right">{{ "%.2f"|format(margin) }}</td>
              </tr>
            {% endfor %}
            {% if top_by_profit|length == 0 %}
              <tr><td colspan="6" class="muted">No sales yet for this month.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card mt-16">
  <div class="card__header">
    <div>
      <div class="h2">Recent orders</div>
      <div class="muted">Last 10 imported sales orders</div>
    </div>
  </div>
  <div class="card__body">
    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Order #</th>
            <th>Channel</th>
            <th class="td-right">Units</th>
            <th class="td-right">Revenue (net)</th>
            <th class="td-right">Profit</th>
            <th class="td-right">Margin %</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for o in recent_orders %}
            {% set t = recent_totals_map.get(o.id, {"rev": 0, "profit": 0, "units": 0}) %}
            {% set rev = t.rev %}
            {% set prof = t.profit %}
            {% set margin = 0 %}
            {% if rev and rev > 0 %}
              {% set margin = (prof / rev) * 100 %}
            {% endif %}
            <tr>
              <td>{{ o.order_date }}</td>
              <td>{{ o.order_number }}</td>
              <td>{{ o.channel }}</td>
              <td class="td-right">{{ t.units or 0 }}</td>
              <td class="td-right">{{ "%.2f"|format(rev or 0) }}</td>
              <td class="td-right">{{ "%.2f"|format(prof or 0) }}</td>
              <td class="td-right">{{ "%.2f"|format(margin) }}</td>
              <td class="td-right">
                <a class="btn btn--ghost btn--sm" href="{{ url_for('sales.sales_order_detail', order_id=o.id) }}">View</a>
              </td>
            </tr>
          {% endfor %}
          {% if recent_orders|length == 0 %}
            <tr><td colspan="8" class="muted">No sales orders yet.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
