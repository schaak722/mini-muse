{% extends "base.html" %}
{% block content %}
<div class="topbar">
  <div>
    <h1 class="h1">Inventory</h1>
    <div class="sub">Arrived stock (IN_STOCK items). Mark items as sold from this page.</div>
  </div>
</div>

<div class="card" style="margin-bottom:14px;">
  <div class="card-body">
    <form method="get" style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">

      <div class="field" style="min-width:340px; flex:1;">
        <label>Search (SKU, Order #, Supplier, Brand, Description)</label>
        <input name="q" value="{{ q or '' }}" placeholder="e.g. SR-PRZE or PO-123 or MayLily">
      </div>

      <div class="field">
        <label>Order date from</label>
        <input type="date" name="order_from" value="{{ order_from or '' }}">
      </div>
      <div class="field">
        <label>Order date to</label>
        <input type="date" name="order_to" value="{{ order_to or '' }}">
      </div>

      <div class="field">
        <label>Arrival from</label>
        <input type="date" name="arrival_from" value="{{ arrival_from or '' }}">
      </div>
      <div class="field">
        <label>Arrival to</label>
        <input type="date" name="arrival_to" value="{{ arrival_to or '' }}">
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn primary" type="submit">Apply</button>
        <a class="btn" href="{{ url_for('routes.items_list') }}">Reset</a>

        <div style="position:relative;">
          <button class="btn" type="button" onclick="toggleMoreActions()">More actions…</button>
          <div id="moreActionsMenu" class="card" style="display:none; position:absolute; right:0; top:42px; min-width:220px; z-index:50;">
            <div class="card-body" style="display:flex; flex-direction:column; gap:8px;">
              <a href="{{ url_for('routes.imports_new') }}">Import Order (CSV)</a>
              <a href="#" onclick="alert('Export list coming in next phase'); return false;">Export list</a>
              <a href="{{ url_for('routes.items_new') }}">Manual input item</a>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Items</div>
  </div>

  <div class="card-body table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:38px;"></th>
          <th>SKU</th>
          <th>Description</th>
          <th>Supplier</th>
          <th>Brand</th>
          <th>Order #</th>
          <th>Order date</th>
          <th>Arrival</th>
          <th>Net cost</th>
          <th>Freight</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for i in items %}
        <tr>
          <td>
            <button class="btn" type="button" style="padding:6px 8px;" onclick="toggleRow('{{ i.pk_id }}')">▸</button>
          </td>
          <td>{{ i.sku }}</td>
          <td>{{ i.item_description }}</td>
          <td>{{ i.company_name }}</td>
          <td>{{ i.brand }}</td>
          <td>{{ i.order_number }}</td>
          <td>{{ i.order_date }}</td>
          <td>{{ i.arrival_date }}</td>
          <td>€{{ i.net_unit_cost }}</td>
          <td>€{{ i.freight_net }}</td>
          <td style="text-align:right;">
            {% if i.status == 'IN_STOCK' %}
              <button class="btn primary" type="button" onclick="openSoldModal('{{ i.pk_id }}', '{{ i.item_description }}', '{{ i.brand }}', '{{ i.sku }}', '{{ i.net_unit_cost }}', '{{ i.freight_net }}')">Sold</button>
            {% else %}
              <span class="badge gray">SOLD</span>
            {% endif %}
          </td>
        </tr>

        <!-- Expanded row -->
        <tr id="row-{{ i.pk_id }}" style="display:none;">
          <td colspan="11" style="background:#fafbfb;">
            <div class="grid cols-2" style="padding:12px;">
              <div><b>Internal Item ID:</b> {{ i.user_item_id }}</div>
              <div><b>VAT rate:</b> {{ i.vat_rate }}</div>
              <div><b>Status:</b>
                {% if i.status == 'IN_STOCK' %}
                  <span class="badge green">IN_STOCK</span>
                {% else %}
                  <span class="badge gray">SOLD</span>
                {% endif %}
              </div>
              <div><b>DB PK:</b> {{ i.pk_id }}</div>
              <div style="grid-column:1 / -1;">
                <a class="btn" href="{{ url_for('routes.items_edit', pk_id=i.pk_id) }}">Edit item</a>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}

        {% if not items %}
        <tr>
          <td colspan="11" style="color: var(--muted);">
            No items found. Try changing filters or import an order CSV.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Sold Modal -->
<div id="soldModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div class="card" style="width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
    <div class="card-header">
      <div class="card-title">Mark Item as Sold</div>
      <button type="button" onclick="closeSoldModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
    </div>
    
    <div class="card-body">
      <form id="soldForm" class="form">
        <input type="hidden" id="item_pk_id" name="item_pk_id">
        
        <!-- Item Info (Read-only) -->
        <div style="background:#f6f6f7; padding:12px; border-radius:10px; margin-bottom:12px;">
          <div style="margin-bottom:8px;"><b id="modal_description"></b></div>
          <div style="font-size:13px; color:var(--muted);">
            <div>Brand: <span id="modal_brand"></span></div>
            <div>SKU: <span id="modal_sku"></span></div>
          </div>
          <div style="margin-top:8px; font-size:12px; color:var(--muted); padding-top:8px; border-top:1px solid var(--border);">
            Net Cost: €<span id="modal_net_cost"></span> | Freight: €<span id="modal_freight"></span>
          </div>
        </div>

        <!-- Sale Date -->
        <div class="field">
          <label>Sale Date *</label>
          <input type="date" name="sale_date" id="sale_date" required>
        </div>

        <!-- Selling Price -->
        <div class="field">
          <label>Final Item Selling Price (gross, VAT-inclusive) *</label>
          <input type="number" step="0.01" name="selling_price" id="selling_price" placeholder="0.00" required>
        </div>

        <!-- Discount -->
        <div class="field">
          <label>Discount (optional)</label>
          <div style="display:flex; gap:8px;">
            <select name="discount_type" id="discount_type" style="width:120px;">
              <option value="">None</option>
              <option value="PERCENT">Percent</option>
              <option value="AMOUNT">Amount</option>
            </select>
            <input type="number" step="0.01" name="discount_value" id="discount_value" placeholder="0.00" style="flex:1;">
          </div>
        </div>

        <!-- Costs -->
        <div class="field">
          <label>Packaging Cost (net)</label>
          <input type="number" step="0.01" name="packaging" id="packaging" placeholder="0.00" value="0.50">
        </div>

        <div class="field">
          <label>Delivery Cost to Business (net)</label>
          <input type="number" step="0.01" name="delivery_cost" id="delivery_cost" placeholder="0.00" value="0.00">
        </div>

        <div class="field">
          <label>Other Cost (net)</label>
          <input type="number" step="0.01" name="other_cost" id="other_cost" placeholder="0.00" value="0.00">
        </div>

        <div class="field">
          <label>Delivery Fee Charged to Buyer (gross, for future reporting)</label>
          <input type="number" step="0.01" name="delivery_fee" id="delivery_fee" placeholder="0.00" value="0.00">
        </div>

        <!-- Notes -->
        <div class="field">
          <label>Notes</label>
          <textarea name="notes" id="notes" placeholder="Optional notes..."></textarea>
        </div>

        <!-- Actions -->
        <div style="display:flex; gap:10px; margin-top:16px;">
          <button type="submit" class="btn primary">Mark as Sold</button>
          <button type="button" class="btn" onclick="closeSoldModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function toggleRow(pk){
  const tr = document.getElementById("row-" + pk);
  if (!tr) return;
  tr.style.display = (tr.style.display === "none" || !tr.style.display) ? "table-row" : "none";
}

function toggleMoreActions(){
  const m = document.getElementById("moreActionsMenu");
  if (!m) return;
  m.style.display = (m.style.display === "none" || !m.style.display) ? "block" : "none";
}

document.addEventListener("click", (e) => {
  const menu = document.getElementById("moreActionsMenu");
  if (!menu) return;
  const btn = e.target.closest("button");
  if (btn && btn.textContent.includes("More actions")) return;
  if (!e.target.closest("#moreActionsMenu")) {
    menu.style.display = "none";
  }
});

// Modal functions
function openSoldModal(pk_id, description, brand, sku, net_cost, freight) {
  document.getElementById('item_pk_id').value = pk_id;
  document.getElementById('modal_description').textContent = description;
  document.getElementById('modal_brand').textContent = brand;
  document.getElementById('modal_sku').textContent = sku;
  document.getElementById('modal_net_cost').textContent = net_cost;
  document.getElementById('modal_freight').textContent = freight;
  
  // Set sale date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('sale_date').value = today;
  
  // Reset form
  document.getElementById('soldForm').reset();
  document.getElementById('sale_date').value = today; // Re-set after reset
  
  // Show modal
  document.getElementById('soldModal').style.display = 'flex';
}

function closeSoldModal() {
  document.getElementById('soldModal').style.display = 'none';
}

// Handle form submission
document.getElementById('soldForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const pk_id = document.getElementById('item_pk_id').value;
  const formData = new FormData(e.target);
  
  try {
    const response = await fetch(`/items/${pk_id}/sell`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert('Item marked as sold!');
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to mark item as sold'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
});

// Close modal on escape key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeSoldModal();
  }
});
</script>
{% endblock %}
