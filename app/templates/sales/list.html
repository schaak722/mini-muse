{% extends "base.html" %}
{% block content %}
<style>
  /* Modern date input styling */
  input[type="date"] {
    position: relative;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 13px;
    font-family: 'Open Sans', sans-serif;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  input[type="date"]:hover {
    border-color: var(--primary);
  }

  input[type="date"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }

  /* Table header styling */
  table th {
    color: var(--text) !important;
    font-weight: 700 !important;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Profit color coding */
  .profit-positive {
    color: var(--success);
    font-weight: 600;
  }

  .profit-negative {
    color: var(--danger);
    font-weight: 600;
  }

  /* Pagination Container */
  .pagination-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    border-top: 1px solid var(--border);
    background: #fafbfb;
    flex-wrap: wrap;
    gap: 16px;
  }

  .pagination-info {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    color: var(--muted);
  }

  .pagination-info select {
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-size: 13px;
    font-family: 'Open Sans', sans-serif;
    background: white;
    cursor: pointer;
  }

  .pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .page-btn {
    min-width: 36px;
    height: 36px;
    padding: 0 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: white;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: var(--text);
    text-decoration: none;
  }

  .page-btn:hover:not(.disabled):not(.ellipsis) {
    border-color: var(--primary);
    color: var(--primary);
  }

  .page-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .page-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
    pointer-events: none;
  }

  .page-btn.ellipsis {
    border: none;
    background: none;
    cursor: default;
    pointer-events: none;
  }

  /* Expanded row styles */
  .expanded-row {
    display: none;
  }

  .expanded-row.show {
    display: table-row;
  }

  .expanded-content {
    background: #fafbfb;
    padding: 16px;
  }

  .detail-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px 24px;
    margin-bottom: 16px;
  }

  .detail-item {
    font-size: 13px;
  }

  .detail-label {
    color: var(--muted);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-weight: 600;
    margin-bottom: 4px;
  }

  .detail-value {
    color: var(--text);
    font-weight: 500;
  }

  .chevron-cell {
    width: 40px;
    text-align: center;
    cursor: pointer;
  }

  .chevron-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: transform 0.2s;
  }

  .chevron-btn.rotated {
    transform: rotate(180deg);
  }

  /* Modal styles */
  .modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-backdrop.active {
    display: flex;
  }

  .modal {
    background: var(--card);
    border-radius: 16px;
    width: 90%;
    max-width: 560px;
    max-height: 90vh;
    overflow: hidden;
    box-shadow: 0 4px 16px rgba(22,29,37,.12);
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-size: 18px;
    font-weight: 700;
  }

  .modal-close-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .modal-close-btn:hover {
    background: #f1f2f3;
  }

  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    background: #fafbfb;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 8px;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    font-family: inherit;
    background: #fafbfb;
    color: var(--text);
  }

  .form-group textarea {
    min-height: 80px;
    resize: vertical;
  }

  .currency-input {
    position: relative;
  }

  .currency-input::before {
    content: '€';
    position: absolute;
    left: 12px;
    top: 10px;
    color: var(--muted);
    font-weight: 600;
  }

  .currency-input input {
    padding-left: 28px;
  }

  .input-group {
    display: flex;
    gap: 8px;
  }

  @media (max-width: 1024px) {
    .detail-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .pagination-container {
      flex-direction: column;
      align-items: stretch;
    }
  }

  @media (max-width: 480px) {
    .detail-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- Search & Filters -->
<div class="card" style="margin-bottom:14px;">
  <div class="card-body">
    <form method="get" style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
      <input type="hidden" name="page" value="1">

      <div class="field" style="min-width:340px; flex:1;">
        <label>Search (SKU, Brand, Description)</label>
        <input name="q" value="{{ q or '' }}" placeholder="Search sales...">
      </div>

      <div class="field" style="width: 140px;">
        <label>Order From</label>
        <input type="date" name="order_from" value="{{ order_from or '' }}">
      </div>

      <div class="field" style="width: 140px;">
        <label>Order To</label>
        <input type="date" name="order_to" value="{{ order_to or '' }}">
      </div>

      <div class="field" style="width: 140px;">
        <label>Sale From</label>
        <input type="date" name="sale_from" value="{{ sale_from or '' }}">
      </div>

      <div class="field" style="width: 140px;">
        <label>Sale To</label>
        <input type="date" name="sale_to" value="{{ sale_to or '' }}">
      </div>

      <button class="btn primary" type="submit">Apply</button>
      <a class="btn" href="{{ url_for('routes.sales_list') }}">Reset</a>

      <div style="position:relative;">
        <button class="btn" type="button" onclick="toggleMoreActions()">More actions…</button>
        <div id="moreActionsMenu" class="card" style="display:none; position:absolute; right:0; top:42px; min-width:220px; z-index:50;">
          <div class="card-body" style="display:flex; flex-direction:column; gap:8px;">
            <a href="#" onclick="alert('Export list coming in next phase'); return false;">Export list</a>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Sold Items</div>
  </div>

  <div class="card-body table-wrap">
    <table>
      <thead>
        <tr>
          <th class="chevron-cell"></th>
          <th>Internal ID</th>
          <th>Sale Date</th>
          <th>Brand</th>
          <th>Item Description</th>
          <th>SKU</th>
          <th>Selling Price</th>
          <th>Net Revenue</th>
          <th>Profit</th>
        </tr>
      </thead>
      <tbody>
        {% for i in items %}
        <tr onclick="toggleRow('{{ i.pk_id }}')" style="cursor: pointer;">
          <td class="chevron-cell">
            <span class="chevron-btn" id="chevron-{{ i.pk_id }}">▼</span>
          </td>
          <td>{{ i.user_item_id }}</td>
          <td>{{ i.sale.sale_date.strftime('%d-%m-%Y') if i.sale.sale_date else '-' }}</td>
          <td>{{ i.brand }}</td>
          <td>{{ i.item_description }}</td>
          <td>{{ i.sku }}</td>
          <td>€{{ i.sale.item_selling_price_gross }}</td>
          <td>€{{ i.sale.item_net_revenue }}</td>
          <td>
            {% if i.sale.item_profit >= 0 %}
              <span class="profit-positive">€{{ i.sale.item_profit }}</span>
            {% else %}
              <span class="profit-negative">€{{ i.sale.item_profit }}</span>
            {% endif %}
          </td>
        </tr>

        <!-- Expanded row -->
        <tr class="expanded-row" id="row-{{ i.pk_id }}">
          <td colspan="9">
            <div class="expanded-content">
              <!-- Row 1: Supplier, Order Number, Order Date, Arrival Date -->
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">Supplier</div>
                  <div class="detail-value">{{ i.company_name }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Order Number</div>
                  <div class="detail-value">{{ i.order_number }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Order Date</div>
                  <div class="detail-value">{{ i.order_date.strftime('%d-%m-%Y') if i.order_date else '-' }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Arrival Date</div>
                  <div class="detail-value">{{ i.arrival_date.strftime('%d-%m-%Y') if i.arrival_date else '-' }}</div>
                </div>
              </div>

              <!-- Row 2: Net Unit Cost, Freight, Packaging, Delivery Cost -->
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">Net Unit Cost</div>
                  <div class="detail-value">€{{ i.net_unit_cost }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Freight</div>
                  <div class="detail-value">€{{ i.freight_net }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Packaging</div>
                  <div class="detail-value">€{{ i.sale.packaging_net }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Delivery Cost</div>
                  <div class="detail-value">€{{ i.sale.delivery_cost_net }}</div>
                </div>
              </div>

              <!-- Row 3: VAT Amount, Discount, Delivery Fee, Status -->
              <div class="detail-grid">
                <div class="detail-item">
                  <div class="detail-label">VAT Amount ({{ (i.vat_rate * 100) | round(0) | int }}%)</div>
                  <div class="detail-value">€{{ i.sale.item_vat_amount }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Discount</div>
                  <div class="detail-value">
                    {% if i.sale.discount_amount_gross %}
                      {% if i.sale.discount_type == 'PERCENT' %}
                        {{ i.sale.discount_value }}% (€{{ i.sale.discount_amount_gross }})
                      {% else %}
                        €{{ i.sale.discount_amount_gross }}
                      {% endif %}
                    {% else %}
                      -
                    {% endif %}
                  </div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Delivery Fee Charged</div>
                  <div class="detail-value">€{{ i.sale.delivery_fee_charged_gross }}</div>
                </div>
                <div class="detail-item">
                  <div class="detail-label">Status</div>
                  <div class="detail-value">
                    <span class="badge" style="background: var(--primary-light); color: var(--primary-dark);">SOLD</span>
                  </div>
                </div>
              </div>

              <!-- Row 4: Notes + Action Buttons -->
              <div class="detail-grid" style="align-items: start;">
                <div style="grid-column: 1 / 3;">
                  <div class="detail-label">Notes</div>
                  <div style="background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 12px; font-size: 13px; min-height: 60px;">
                    {% if i.sale.notes %}
                      {{ i.sale.notes }}
                    {% else %}
                      <span style="color: var(--muted); font-style: italic;">No notes</span>
                    {% endif %}
                  </div>
                </div>

                <div></div>

                <div style="display: flex; flex-direction: column; gap: 10px;">
                  <button class="btn primary" type="button" onclick="event.stopPropagation(); openEditModal('{{ i.pk_id }}', '{{ i.sale.pk_id }}', '{{ i.sale.sale_date.isoformat() }}', '{{ i.sale.item_selling_price_gross }}', '{{ i.sale.packaging_net }}', '{{ i.sale.delivery_cost_net }}', '{{ i.sale.other_cost_net }}', '{{ i.sale.delivery_fee_charged_gross }}', '{{ i.sale.discount_type or '' }}', '{{ i.sale.discount_value or '' }}', {{ i.sale.notes | tojson }})">Edit Sale</button>
                  <button class="btn" type="button" style="background: var(--danger); border-color: var(--danger); color: white;" onclick="event.stopPropagation(); openReverseModal('{{ i.sale.pk_id }}', '{{ i.user_item_id }}', '{{ i.item_description }}')">Reverse Sale</button>
                </div>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}

        {% if not items %}
        <tr>
          <td colspan="9" style="color: var(--muted); text-align: center; padding: 40px;">
            No sales yet. Mark items as sold from the Inventory page.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination at Bottom -->
  {% if total_count > 0 %}
  <div class="pagination-container">
    <div class="pagination-info">
      <span>Showing <strong>{{ start_item }}-{{ end_item }}</strong> of <strong>{{ total_count }}</strong> items</span>
      <span style="color: var(--border);">|</span>
      <label>Items per page:</label>
      <select onchange="updatePerPage(this.value)">
        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </div>

    <div class="pagination-controls">
      {% if page > 1 %}
        <a href="{{ build_url(page - 1) }}" class="page-btn">‹</a>
      {% else %}
        <span class="page-btn disabled">‹</span>
      {% endif %}

      {% for p in page_range %}
        {% if p == '...' %}
          <span class="page-btn ellipsis">...</span>
        {% elif p == page %}
          <span class="page-btn active">{{ p }}</span>
        {% else %}
          <a href="{{ build_url(p) }}" class="page-btn">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if page < total_pages %}
        <a href="{{ build_url(page + 1) }}" class="page-btn">›</a>
      {% else %}
        <span class="page-btn disabled">›</span>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Edit Sale Modal -->
<div id="editModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Edit Sale</div>
      <button type="button" class="modal-close-btn" onclick="closeEditModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="edit_sale_id" name="sale_id">
        
        <div class="form-group">
          <label>Sale Date</label>
          <input type="date" id="edit_sale_date" name="sale_date" required>
        </div>

        <div class="form-group">
          <label>Final Selling Price (VAT-inclusive)</label>
          <div class="currency-input">
            <input type="number" step="0.01" id="edit_selling_price" name="selling_price" required>
          </div>
        </div>

        <div class="form-group">
          <label>Packaging Cost</label>
          <div class="currency-input">
            <input type="number" step="0.01" id="edit_packaging" name="packaging">
          </div>
        </div>

        <div class="form-group">
          <label>Delivery Cost to Business</label>
          <div class="currency-input">
            <input type="number" step="0.01" id="edit_delivery_cost" name="delivery_cost">
          </div>
        </div>

        <div class="form-group">
          <label>Other Cost</label>
          <div class="currency-input">
            <input type="number" step="0.01" id="edit_other_cost" name="other_cost">
          </div>
        </div>

        <div class="form-group">
          <label>Delivery Fee Charged to Buyer</label>
          <div class="currency-input">
            <input type="number" step="0.01" id="edit_delivery_fee" name="delivery_fee">
          </div>
        </div>

        <div class="form-group">
          <label>Discount</label>
          <div class="input-group">
            <select id="edit_discount_type" name="discount_type" style="width: 140px;">
              <option value="">None</option>
              <option value="PERCENT">Percent</option>
              <option value="AMOUNT">Amount</option>
            </select>
            <input type="number" step="0.01" id="edit_discount_value" name="discount_value" placeholder="0.00">
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea id="edit_notes" name="notes"></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
      <button type="button" class="btn primary" onclick="submitEditForm()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Reverse Sale Modal -->
<div id="reverseModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Reverse Sale</div>
      <button type="button" class="modal-close-btn" onclick="closeReverseModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; padding: 16px; margin-bottom: 20px;">
        <strong>⚠️ Warning:</strong> This will return the item to inventory and delete the sale record. This action cannot be undone.
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Item:</strong> <span id="reverse_item_id"></span> - <span id="reverse_item_desc"></span>
      </div>

      <form id="reverseForm">
        <input type="hidden" id="reverse_sale_id" name="sale_id">
        
        <div class="form-group">
          <label>Reason for Reversal (required)</label>
          <textarea id="reverse_reason" name="reason" required placeholder="e.g., Customer returned item, Error in sale entry..."></textarea>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn" onclick="closeReverseModal()">Cancel</button>
      <button type="button" class="btn" style="background: var(--danger); border-color: var(--danger); color: white;" onclick="submitReverseForm()">Reverse Sale</button>
    </div>
  </div>
</div>

<script>
let currentOpenRow = null;

function toggleRow(pk) {
  const row = document.getElementById("row-" + pk);
  const chevron = document.getElementById("chevron-" + pk);
  
  if (!row) return;
  
  if (currentOpenRow && currentOpenRow !== pk) {
    const prevRow = document.getElementById("row-" + currentOpenRow);
    const prevChevron = document.getElementById("chevron-" + currentOpenRow);
    if (prevRow) prevRow.classList.remove("show");
    if (prevChevron) prevChevron.classList.remove("rotated");
  }
  
  const isOpen = row.classList.contains("show");
  if (isOpen) {
    row.classList.remove("show");
    chevron.classList.remove("rotated");
    currentOpenRow = null;
  } else {
    row.classList.add("show");
    chevron.classList.add("rotated");
    currentOpenRow = pk;
  }
}

function updatePerPage(value) {
  const url = new URL(window.location.href);
  url.searchParams.set('per_page', value);
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

function toggleMoreActions() {
  const m = document.getElementById("moreActionsMenu");
  if (!m) return;
  m.style.display = (m.style.display === "none" || !m.style.display) ? "block" : "none";
}

document.addEventListener("click", (e) => {
  const menu = document.getElementById("moreActionsMenu");
  if (!menu) return;
  const btn = e.target.closest("button");
  if (btn && btn.textContent.includes("More actions")) return;
  if (!e.target.closest("#moreActionsMenu")) {
    menu.style.display = "none";
  }
});

// Edit Modal
function openEditModal(item_pk, sale_pk, sale_date, selling_price, packaging, delivery_cost, other_cost, delivery_fee, discount_type, discount_value, notes) {
  document.getElementById('edit_sale_id').value = sale_pk;
  document.getElementById('edit_sale_date').value = sale_date;
  document.getElementById('edit_selling_price').value = selling_price;
  document.getElementById('edit_packaging').value = packaging;
  document.getElementById('edit_delivery_cost').value = delivery_cost;
  document.getElementById('edit_other_cost').value = other_cost;
  document.getElementById('edit_delivery_fee').value = delivery_fee;
  document.getElementById('edit_discount_type').value = discount_type || '';
  document.getElementById('edit_discount_value').value = discount_value || '';
  document.getElementById('edit_notes').value = notes || '';
  
  document.getElementById('editModal').classList.add('active');
}

function closeEditModal() {
  document.getElementById('editModal').classList.remove('active');
}

async function submitEditForm() {
  const form = document.getElementById('editForm');
  const sale_id = document.getElementById('edit_sale_id').value;
  const formData = new FormData(form);
  
  try {
    const response = await fetch(`/sales/${sale_id}/edit`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert('Sale updated successfully!');
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to update sale'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

// Reverse Modal
function openReverseModal(sale_pk, item_id, item_desc) {
  document.getElementById('reverse_sale_id').value = sale_pk;
  document.getElementById('reverse_item_id').textContent = item_id;
  document.getElementById('reverse_item_desc').textContent = item_desc;
  document.getElementById('reverse_reason').value = '';
  
  document.getElementById('reverseModal').classList.add('active');
}

function closeReverseModal() {
  document.getElementById('reverseModal').classList.remove('active');
}

async function submitReverseForm() {
  const form = document.getElementById('reverseForm');
  const sale_id = document.getElementById('reverse_sale_id').value;
  const formData = new FormData(form);
  
  if (!formData.get('reason')) {
    alert('Please provide a reason for reversal');
    return;
  }
  
  if (!confirm('Are you absolutely sure? This will delete the sale and return the item to inventory.')) {
    return;
  }
  
  try {
    const response = await fetch(`/sales/${sale_id}/reverse`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (response.ok) {
      alert('Sale reversed successfully!');
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to reverse sale'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
}

// Close modals on escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeEditModal();
    closeReverseModal();
  }
});

// Close modals on backdrop click
document.getElementById('editModal').addEventListener('click', (e) => {
  if (e.target.id === 'editModal') closeEditModal();
});
document.getElementById('reverseModal').addEventListener('click', (e) => {
  if (e.target.id === 'reverseModal') closeReverseModal();
});
</script>
{% endblock %}
